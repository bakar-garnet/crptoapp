name: Garnet CI Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Add Garnet Monitor
        uses: garnet-org/action@v1
        with:
          api_token: ${{ secrets.GARNET_API_TOKEN }}

      - name: Workload (Node + Solidity + Python)
        run: |
          set -euxo pipefail

          echo "=== System info ==="
          id
          uname -a
          node -v || true
          npm -v || true
          python3 -V || true
          pip3 -V || true

          echo "=== Install node deps ==="
          npm ci

          echo "=== Hardhat compile + test + local chain ==="
          npm run build
          npm test

          echo "=== Run node workload ==="
          npm run workload

          echo "=== Python deps + run probe ==="
          python3 -m pip install --upgrade pip
          pip3 install -r python/requirements.txt
          python3 python/chain_probe.py

          echo "DONE"
